version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: puu-tracker-app
    restart: always
    ports:
      - "3006:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://puu_admin:puu123@postgres:5432/puu_tracker?schema=public
      - NEXTAUTH_URL=http://localhost:3006
      - AUTH_SECRET=${AUTH_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_MODEL=${OPENAI_MODEL}
      - GOOGLE_VISION_API_KEY=${GOOGLE_VISION_API_KEY}
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_USE_SSL=false
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
    depends_on:
      - postgres
      - minio

  postgres:
    image: postgres:15-alpine
    container_name: puu-tracker-postgres
    restart: always
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_USER=puu_admin
      - POSTGRES_PASSWORD=puu123
      - POSTGRES_DB=puu_tracker
    volumes:
      - postgres_data:/var/lib/postgresql/data

  minio:
    image: minio/minio
    container_name: puu-tracker-minio
    restart: always
    ports:
      - "9002:9000"
      - "9003:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"

  createbuckets:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c " /usr/bin/mc config host add myminio http://minio:9000 ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY}; /usr/bin/mc mb myminio/${MINIO_BUCKET_NAME}; /usr/bin/mc anonymous set download myminio/${MINIO_BUCKET_NAME}; exit 0; "

volumes:
  postgres_data:
  minio_data:
